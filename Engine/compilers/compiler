os.loadAPI("/SolaEngine/Engine/Config")
-- Variables

input = nil
running = true
allowBuild = false

-- Functions

function draw()
  term.setBackgroundColor(colors.gray)
  term.clear()
  term.setCursorPos(1,3)
  term.setTextColor(colors.white)
  write("Type in the name of your main Script file:")
  term.setCursorPos(1,5)
  term.setBackgroundColor(colors.white)
  print("                              ") -- 30
  term.setCursorPos(1,7)
  term.setBackgroundColor(colors.lightBlue)
  term.setTextColor(colors.black)
  print("       ")
  print(" Build ")
  print("       ")
  term.setBackgroundColor(colors.yellow)
  term.setCursorPos(10,7)
  print("        ")
  term.setCursorPos(10,8)
  print(" Cancel ")
  term.setCursorPos(10,9)
  print("        ")
  term.setBackgroundColor(colors.gray)
end

function build()

  if fs.exists("/SolaEngine/output/"..Config.ProjectName) then
    local ok, er = pcall(
      function()
        fs.delete("/SolaEngine/output/"..Config.ProjectName)
      end
    )

    if not ok then
      local err = "Error ID(2): "..string.gsub(er, ".+:+.+:+[ ]", "")
      term.setBackgroundColor(colors.red)
      term.setTextColor(colors.white)
      term.setCursorPos(1,6)
      print(err)
      running = true
      return
    end
  end

  local ok, er = pcall(
    function()
      fs.copy(Config.CurrentProject, "/SolaEngine/output/"..Config.ProjectName.."/game")
      fs.copy("/SolaEngine/APIS", "/SolaEngine/output/"..Config.ProjectName.."/APIS/")
    end
  )

  if not ok then
    local err = "Error ID(2): "..string.gsub(er, ".+:+.+:+[ ]", "")
    term.setBackgroundColor(colors.red)
    term.setTextColor(colors.white)
    term.setCursorPos(1,6)
    print(err)
    running = true
    return
  end

  file = fs.open("/SolaEngine/output/"..Config.ProjectName.."/"..Config.ProjectName, "w")
  file.writeLine("----------------------------------------")
  file.writeLine("--                                    --")
  file.writeLine("--          AUTO-GENERATED BY:        --")
  file.writeLine("--             SOLA-ENGINE,           --")
  file.writeLine("--               Made by              --")
  file.writeLine("--                CCTech              --")
  file.writeLine("----------------------------------------")
  file.writeLine(" ")
  file.writeLine("local dir = shell.getRunningProgram()")
  file.writeLine('local path = fs.getDir(dir)')
  file.writeLine(' ')
  file.writeLine('os.loadAPI(path.."/APIS/collisions")')
  file.writeLine('os.loadAPI(path.."/APIS/game")')
  file.writeLine('os.loadAPI(path.."/APIS/player")')
  file.writeLine('shell.run(path.."/game/'..input..'")')
  file.close()
end

function finish()
  term.setBackgroundColor(colors.gray)
  term.setTextColor(colors.white)
  term.clear()

  local x, y = term.getCursorPos()
  local w, h = term.getSize()
  local String = "Game has been built. Press any key to return to the Engine"
  term.setCursorPos(math.floor((w - #String) / 2) + 1, y)
  term.write(String)
  running = false
  term.setCursorPos(1,1)
  term.setBackgroundColor(colors.black)
  term.setTextColor(colors.white)
  term.clear()
  shell.run("/SolaEngine/Engine/Editors/ComponentEditor")
end

function runTime()
  while running do
    local event, button, x, y = os.pullEvent("mouse_click")
    if allowBuild == true and button == 1 and x <= 7 and y >= 7 and y <= 9 then
      build()
      finish()
    elseif button == 1 and x >= 10 and x <= 18 and y <= 9 and y >= 7 then
      running = false
      shell.run("/SolaEngine/Engine/Editors/ComponentEditor")
    elseif button == 1 and x <= 30 and y == 5 then
      running = false
      term.setCursorPos(1,5)
      term.setBackgroundColor(colors.white)
      term.setTextColor(colors.black)
      print("                              ")
      term.setCursorPos(1,5)
      input = read()

      if not fs.exists(Config.CurrentProject.."/"..input) then
        term.setBackgroundColor(colors.red)
        term.setTextColor(colors.white)
        term.setCursorPos(1,6)
        print("Error ID(1): script not found!")
        allowBuild = false
        running = true
      else
        running = true
        allowBuild = true
      end
    end
  end
end

function init()
  draw()
  runTime()
end

-- Main

init()